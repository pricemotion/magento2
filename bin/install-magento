#!/bin/bash

set -euo pipefail
cd "$(dirname "$0")/.."

magento_version='2.3.6'

if [[ $# -eq 1 ]]; then
	magento_version="$1"
elif [[ $# -gt 1 ]]; then
	echo "Usage: $0 [version]" >&2
	exit 1
fi

retrieve() {
	tmp="$(mktemp)"
	if ! wget -O "$tmp" "$2" ||
	   ! sha256sum --strict -c <<<"$3 $tmp"
	then
		rm -f "$tmp"
		return $?
	fi
	mv "$tmp" "$1"
}

if [[ ! -f vendor/bin/composer ]]; then
	mkdir -p vendor/bin
	retrieve vendor/bin/composer \
			 'https://getcomposer.org/download/1.10.17/composer.phar' \
			 6fa00eba5103ce6750f94f87af8356e12cc45d5bbb11a140533790cf60725f1c
	chmod +x vendor/bin/composer
fi

docker-compose stop web

rm -rf www

COMPOSER_MEMORY_LIMIT=-1 vendor/bin/composer create-project \
	--ignore-platform-reqs \
	--repository-url=https://repo.magento.com/ \
	"magento/project-community-edition=$magento_version" \
	www

docker-compose up -d

while ! mysql -h "$(docker-ip magento2_mariadb_1)" -e "SELECT 1" >/dev/null; do
	sleep 0.5
done

mysql -h "$(docker-ip magento2_mariadb_1)" <<-EOF
	DROP DATABASE IF EXISTS magento;
	CREATE DATABASE magento;
EOF

if [[ -f  ~/.config/composer/auth.json ]]; then
	mkdir -p www/var/composer_home
	cat ~/.config/composer/auth.json |
		jq '. | map_values(with_entries(select(.key == "repo.magento.com")))' \
		> www/var/composer_home/auth.json
fi

bin/magento sampledata:deploy

bin/magento setup:install \
	--base-url=http://pricemotion-magento2.test \
	--db-host=mariadb \
	--db-name=magento \
	--db-user=root \
	--admin-firstname=Admin \
	--admin-lastname=Admin \
	--admin-email=info@pricemotion.nl \
	--admin-user=admin \
	--admin-password=admin123 \
	--language=en_US \
	--currency=EUR \
	--timezone=Europe/Amsterdam \
	--use-rewrites=1 \
	--backend-frontname=admin

bin/magento config:set dev/template/allow_symlink 1

bin/magento cache:clean

bin/magento config:set admin/security/password_lifetime 0
bin/magento config:set admin/security/password_is_forced 0
