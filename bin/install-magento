#!/bin/bash

set -euo pipefail
cd "$(dirname "$0")/.."

magento_version='2.3.6'

docker-compose down

rm -rf www

COMPOSER_MEMORY_LIMIT=-1 composer create-project \
	--ignore-platform-reqs \
	--repository-url=https://repo.magento.com/ \
	"magento/project-community-edition=$magento_version" \
	www

docker-compose up -d

while ! mysql -h "$(docker-ip magento2_mariadb_1)" -e "SELECT 1" >/dev/null; do
	sleep 0.5
done

bin/magento setup:install \
	--base-url=http://pricemotion-magento2.test \
	--db-host=mariadb \
	--db-name=magento \
	--db-user=root \
	--admin-firstname=Admin \
	--admin-lastname=Admin \
	--admin-email=info@pricemotion.nl \
	--admin-user=admin \
	--admin-password=admin123 \
	--language=en_US \
	--currency=EUR \
	--timezone=Europe/Amsterdam \
	--use-rewrites=1 \
	--backend-frontname=admin

bin/magento config:set dev/template/allow_symlink 1
